<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ¨ 2D è®Šå…¬ä»”é­”æ³•å±‹ - å¯¦æˆ°ç‰ˆ âœ¨</title>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
    <style>
        /* --- å¯æ„›é¢¨é…è‰²èˆ‡æ’ç‰ˆ --- */
        body {
            font-family: 'Varela Round', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
            background-color: #fef6fb;
            color: #5d5d5d;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 { color: #ff8fab; margin-top: 30px; font-size: 2.5rem; text-shadow: 2px 2px white; }
        .container {
            width: 90%; max-width: 1000px; background: white; border-radius: 20px;
            box-shadow: 0 10px 25px rgba(255, 143, 171, 0.2); padding: 30px; margin: 20px 0; text-align: center;
        }
        .tabs { display: flex; justify-content: center; margin-bottom: 20px; }
        .tab-btn {
            background: #ffe5ec; border: none; padding: 12px 30px; font-size: 1.1rem;
            cursor: pointer; border-radius: 30px; margin: 0 10px; color: #ff8fab;
            font-weight: bold; transition: 0.3s;
        }
        .tab-btn.active, .tab-btn:hover { background: #ff8fab; color: white; }
        .input-section { display: none; animation: fadeIn 0.5s; }
        .input-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .upload-box {
            border: 3px dashed #ffc2d1; padding: 40px; border-radius: 15px;
            cursor: pointer; background: #fff0f5; transition: 0.3s;
        }
        .upload-box:hover { background: #ffe5ec; border-color: #ff8fab; }
        input[type="text"] {
            width: 70%; padding: 15px; border: 2px solid #ffc2d1; border-radius: 10px;
            font-size: 1rem; outline: none;
        }
        .generate-btn {
            background: linear-gradient(45deg, #ff8fab, #fb6f92); color: white; border: none;
            padding: 15px 40px; font-size: 1.2rem; border-radius: 50px; margin-top: 20px;
            cursor: pointer; box-shadow: 0 5px 15px rgba(251, 111, 146, 0.4); transition: transform 0.2s;
        }
        .generate-btn:hover { transform: scale(1.05); }
        .generate-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .viewer-container { margin-top: 40px; border-top: 2px solid #f0f0f0; padding-top: 20px; }
        model-viewer { width: 100%; height: 400px; background-color: #f7f7f7; border-radius: 15px; }
        .loader {
            display: none; margin: 20px auto; border: 5px solid #f3f3f3;
            border-top: 5px solid #ff8fab; border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <h1>âœ¨ 2D è®Šå…¬ä»”é­”æ³•å±‹ âœ¨</h1>

    <div class="container">
        <p style="color:red; font-weight:bold;">ğŸš¨ é€™æ˜¯ API å¯¦æˆ°ç‰ˆï¼šåœ¨æœ¬åœ°é–‹å•Ÿå¯èƒ½å›  CORS é™åˆ¶è€Œå¤±æ•—ã€‚è«‹éƒ¨ç½²åˆ°ç¶²ç«™ä¸Šä½¿ç”¨ï¼</p>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('img23d', this)">åœ–ç‰‡è½‰ 3D</button>
            <button class="tab-btn" onclick="switchTab('txt23d', this)">æ–‡å­—è½‰ 3D</button>
        </div>

        <div id="img23d" class="input-section active">
            <p>ä¸Šå‚³æ‚¨çš„ 2D ç•«ä½œï¼ˆæ­£é¢åœ–æ•ˆæœæœ€å¥½å–”ï¼ï¼‰</p>
            <div class="upload-box" onclick="document.getElementById('fileInput').click()">
                <p>ğŸ“ é»æ“Šé€™è£¡ä¸Šå‚³åœ–ç‰‡</p>
                <input type="file" id="fileInput" hidden accept="image/*">
            </div>
            <img id="previewImg" style="max-width: 200px; margin-top: 10px; border-radius: 10px; display:none;">
            <br>
            <button class="generate-btn" onclick="startGeneration('img23d')">é–‹å§‹è£½ä½œå…¬ä»”ï¼</button>
        </div>

        <div id="txt23d" class="input-section">
            <p>ç”¨æ–‡å­—æè¿°æ‚¨æƒ³åƒä¸­çš„å…¬ä»” (è«‹ä½¿ç”¨è‹±æ–‡ï¼Œæ•ˆæœæœ€ä½³)</p>
            <input type="text" id="textPrompt" placeholder="ä¾‹å¦‚ï¼šA cute orange cat wearing a space suit, low-poly style...">
            <br>
            <button class="generate-btn" onclick="startGeneration('txt23d')">é–‹å§‹æ–½æ³•ï¼</button>
        </div>

        <div class="loader" id="loader"></div>

        <div class="viewer-container" id="resultArea" style="display:none;">
            <h3>ğŸ‰ å®Œæˆäº†ï¼æ‚¨çš„å…¬ä»”é è¦½ï¼š</h3>
            <p id="modelMessage">è©¦è‘—ç”¨æ»‘é¼ æ‹–æ›³æ—‹è½‰å®ƒï¼ (ç›®å‰é¡¯ç¤ºç¯„ä¾‹æ¨¡å‹)</p>
            
            <model-viewer 
                id="modelViewer"
                src="https://modelviewer.dev/shared-assets/models/Astronaut.glb" 
                alt="3Då…¬ä»”" 
                auto-rotate 
                camera-controls 
                shadow-intensity="1">
            </model-viewer>
            
            <br>
            <a id="downloadGLB" class="tab-btn" style="background:#4ecdc4; color:white; display:none;" download="my_kawaii_model.glb">â¬‡ï¸ ä¸‹è¼‰ .GLB æª”</a>
        </div>
    </div>

    <script>
        // ==========================================================
        //         !!! ç¬¬ 1 æ­¥ï¼šæ›¿æ›æ‚¨çš„é‡‘é‘°åœ¨é€™è£¡ !!!
        // ==========================================================
        const MESHY_API_KEY = 'YOUR_MESHY_API_KEY_HERE'; 
        // ==========================================================
        
        const TEXT_TO_3D_URL = 'https://api.meshy.ai/v1/text-to-3d'; 

        // è¼”åŠ©å‡½å¼ï¼šåˆ‡æ›åˆ†é 
        function switchTab(tabId, button) {
            document.querySelectorAll('.input-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            button.classList.add('active');
        }

        // è¼”åŠ©å‡½å¼ï¼šé è¦½ä¸Šå‚³åœ–ç‰‡
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('previewImg');
                    img.src = e.target.result;
                    img.style.display = 'inline-block';
                }
                reader.readAsDataURL(file);
            }
        });

        // ä¸»è¦å‡½å¼ï¼šé–‹å§‹ç”Ÿæˆ 3D æ¨¡å‹
        async function startGeneration(mode) {
            const generateBtn = document.querySelector(`#${mode} .generate-btn`);

            if (MESHY_API_KEY === 'msy_m3ZXssCi82PYJciIN4RTXbR6IKUiGciNfjNR') {
                alert("ğŸš¨ éŒ¯èª¤ï¼šè«‹å…ˆå°‡ç¨‹å¼ç¢¼ä¸­çš„ 'YOUR_MESHY_API_KEY_HERE' æ›¿æ›æˆæ‚¨çœŸæ­£çš„ Meshy API é‡‘é‘°ï¼");
                return;
            }

            // 1. æº–å‚™è¼¸å…¥è³‡æ–™
            let prompt = '';
            if (mode === 'txt23d') {
                prompt = document.getElementById('textPrompt').value.trim();
                if (!prompt) {
                    alert("è«‹è¼¸å…¥æ–‡å­—æè¿°ï¼");
                    return;
                }
            } else if (mode === 'img23d') {
                // åœ–ç‰‡è½‰ 3D çš„ API æµç¨‹æ›´è¤‡é›œï¼Œé€™è£¡æˆ‘å€‘åªè™•ç† Text-to-3D
                // æˆ‘å€‘å¼·åˆ¶çµ¦ä¸€å€‹å¯æ„›çš„æç¤ºä¾†è™•ç†åœ–ç‰‡æ¨¡å¼ï¼Œä½† API ä»æœƒèµ° Text-to-3D æµç¨‹ã€‚
                // å¯¦æˆ°ä¸­éœ€è¦å…ˆä¸Šå‚³åœ–ç‰‡åˆ° Meshyï¼Œä¸¦å–å¾— URLï¼Œé€™æ˜¯è¤‡é›œçš„å¾Œç«¯å·¥ä½œã€‚
                prompt = document.getElementById('textPrompt').value.trim() || "A cute cartoon character from a 2D drawing, turned into a beautiful 3D figurine, kawaii style, vibrant colors.";
            }

            // 2. æ›´æ–°ä»‹é¢ç‚ºè®€å–ç‹€æ…‹
            document.getElementById('loader').style.display = 'block';
            document.getElementById('resultArea').style.display = 'none';
            document.getElementById('downloadGLB').style.display = 'none';
            generateBtn.disabled = true;
            generateBtn.innerText = "AI æ­£åœ¨åŠªåŠ›å»ºæ¨¡ä¸­... (è«‹ç¨å€™)";

            // 3. ç™¼é€ API è«‹æ±‚é–‹å§‹ç”Ÿæˆ
            try {
                const response = await fetch(TEXT_TO_3D_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${MESHY_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        art_style: 'kawaii', // å¼·èª¿å¯æ„›é¢¨æ ¼
                        output_format: 'glb',
                        mode: 'precise' // é«˜å“è³ªæ¨¡å¼
                    })
                });

                const data = await response.json();

                if (response.status !== 200 || data.code !== 0) {
                    console.error("Meshy API éŒ¯èª¤:", data);
                    throw new Error(`API å‘¼å«å¤±æ•—ï¼éŒ¯èª¤è¨Šæ¯ï¼š${data.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                }

                const taskID = data.result.task_id;
                console.log("ä»»å‹™é–‹å§‹ï¼ŒID:", taskID);

                // 4. è¼ªè©¢æª¢æŸ¥ç”Ÿæˆç‹€æ…‹
                const modelURL = await pollTaskStatus(taskID, generateBtn);

                // 5. é¡¯ç¤ºçµæœ
                if (modelURL) {
                    updateModelViewer(modelURL);
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('resultArea').style.display = 'block';
                    document.getElementById('modelMessage').innerText = `æ‚¨çš„æ¨¡å‹å·²ç”Ÿæˆï¼`;
                    document.getElementById('downloadGLB').href = modelURL;
                    document.getElementById('downloadGLB').style.display = 'inline-block';
                } else {
                    alert("æ¨¡å‹ç”Ÿæˆå¤±æ•—æˆ–è¶…æ™‚ï¼Œè«‹é‡è©¦ã€‚");
                }
                
                generateBtn.disabled = false;
                generateBtn.innerText = "å†æ¬¡ç”Ÿæˆ";

            } catch (error) {
                console.error('ç”Ÿæˆéç¨‹ç™¼ç”ŸéŒ¯èª¤:', error);
                alert(`éŒ¯èª¤ç™¼ç”Ÿï¼š${error.message}\n\nğŸš¨ è«‹æ³¨æ„ï¼šå¦‚æœæ˜¯ CORS éŒ¯èª¤ï¼Œè¡¨ç¤ºæ‚¨çš„ç¶²é æ²’æœ‰éƒ¨ç½²åˆ°å…¬é–‹ç¶²ç«™ï¼`);
                document.getElementById('loader').style.display = 'none';
                generateBtn.disabled = false;
                generateBtn.innerText = "å†æ¬¡ç”Ÿæˆ";
            }
        }

        // è¼”åŠ©å‡½å¼ï¼šè¼ªè©¢æª¢æŸ¥ä»»å‹™ç‹€æ…‹
        async function pollTaskStatus(taskID, generateBtn) {
            const STATUS_URL = `https://api.meshy.ai/v1/tasks/${taskID}`;
            let status = 'PENDING';
            let attempt = 0;
            const maxAttempts = 30; // æœ€å¤šæª¢æŸ¥ 30 æ¬¡ï¼Œæ¯æ¬¡é–“éš” 10 ç§’ = 300 ç§’ (5åˆ†é˜)

            while (status === 'PENDING' || status === 'IN_PROGRESS' || status === 'QUEUED') {
                if (attempt >= maxAttempts) {
                    return null; // è¶…æ™‚
                }

                // ç­‰å¾… 10 ç§’
                await new Promise(resolve => setTimeout(resolve, 10000)); 
                attempt++;
                generateBtn.innerText = `AI å»ºæ¨¡ä¸­... ç‹€æ…‹æª¢æŸ¥: ${attempt} æ¬¡ (ç´„ ${attempt * 10} ç§’)`;

                try {
                    const response = await fetch(STATUS_URL, {
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${MESHY_API_KEY}` }
                    });

                    const data = await response.json();
                    status = data.result.status;

                    if (status === 'SUCCEEDED') {
                        return data.result.model_url; 
                    } else if (status === 'FAILED') {
                        console.error("ç”Ÿæˆä»»å‹™å¤±æ•—:", data.result.error_message);
                        alert(`ç”Ÿæˆå¤±æ•—: ${data.result.error_message}`);
                        return null;
                    }

                } catch (error) {
                    console.error('è¼ªè©¢ç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    return null;
                }
            }
            return null; // ç‹€æ…‹ç•°å¸¸
        }

        // è¼”åŠ©å‡½å¼ï¼šæ›´æ–° 3D æª¢è¦–å™¨
        function updateModelViewer(url) {
            const viewer = document.getElementById('modelViewer');
            viewer.setAttribute('src', url);
        }
    </script>

</body>
</html>